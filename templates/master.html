<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Home Page{% endblock %}</title>
  {% include "style.html" %}
  <!-- FontAwesome for star icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
</head>

<body>
  <div id="productApp">
    {% block navbar_content %}
      {% include "components/navbar.html" %}
    {% endblock %}

    {% block carousel_content %}
      <div style="background-color: #f8f9fa;">
        {% include "components/carousel.html" %}
      </div>
    {% endblock %}

    <div class="container">
      {% block main_content %}{% endblock %}
    </div>

    {% include "components/cart_modal.html" %}

    {% block footer_content %}
      {% include "components/footer.html" %}
    {% endblock %}
  </div>
</body>

{% include "script.html" %}

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  setup() {
    const cart_list = ref(JSON.parse(localStorage.getItem('cart') ?? '[]'));
    const cartCount = computed(() =>
      cart_list.value.reduce((total, item) => total + (item.qty || 1), 0)
    );

    const searchQuery = ref('');
    const priceLimit = ref(500);
    const selected_product = ref({});
    const quantity = ref(1);

    const products = ref({{ products|default([])|tojson|safe }});
    const product = ref({{ product|default({})|tojson|safe }});

    const subtotal = computed(() =>
      cart_list.value.reduce((sum, item) => sum + item.price * item.qty, 0).toFixed(2)
    );
    const shipping = computed(() =>
      cart_list.value.length > 0 ? 2.99 : 0
    );
    const tax = computed(() =>
      (parseFloat(subtotal.value) * 0.1).toFixed(2)
    );
    const total = computed(() =>
      (parseFloat(subtotal.value) + shipping.value + parseFloat(tax.value)).toFixed(2)
    );

    const filteredProducts = computed(() =>
      products.value.filter(p =>
        p.title.toLowerCase().includes(searchQuery.value.toLowerCase()) &&
        p.price <= priceLimit.value
      )
    );

    const addToCart = (item = product.value) => {
      if (quantity.value < 1) {
        alert('Quantity must be at least 1');
        return;
      }
      if (!item.image || item.image.trim() === '') {
        item.image = '/static/default.jpg';
      }

      const existing = cart_list.value.find(p => p.id === item.id);
      if (existing) {
        existing.qty += quantity.value;
      } else {
        cart_list.value.push({ ...item, qty: quantity.value });
      }

      localStorage.setItem('cart', JSON.stringify(cart_list.value));

      Swal.fire({
        icon: 'success',
        title: 'Added to Cart',
        text: `${item.title} x${quantity.value} added.`,
        timer: 1200,
        showConfirmButton: false
      });
    };

    const removeCartItem = (index) => {
      Swal.fire({
        title: 'Are you sure?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, remove it!',
        cancelButtonText: 'Cancel',
      }).then(result => {
        if (result.isConfirmed) {
          cart_list.value.splice(index, 1);
          localStorage.setItem('cart', JSON.stringify(cart_list.value));
        }
      });
    };

    const increaseQty = (item) => {
      if (item.qty < 10) {
        item.qty++;
        localStorage.setItem('cart', JSON.stringify(cart_list.value));
      }
    };

    const decreaseQty = (item) => {
      if (item.qty > 1) {
        item.qty--;
        localStorage.setItem('cart', JSON.stringify(cart_list.value));
      }
    };

    const showProductDetail = (p) => {
      selected_product.value = p;
      selected_product.value.userRating = 0; // reset user rating
      $('#productModal').modal('show');
    };

    const isCartModalVisible = ref(false);
    const showCartModal = () => {
      isCartModalVisible.value = true;
    };
    const proceedToPurchase = () => {
      isCartModalVisible.value = false;
      window.location.href = "/cart";
    };

    const checkout = () => {
      window.location.href = "/checkout";
    };

    const validateCheckout = () => {
      const name = document.getElementById("name")?.value.trim();
      const email = document.getElementById("email")?.value.trim();
      const address = document.getElementById("address")?.value.trim();
      const cart = cart_list.value;

      if (!name || name.length < 4) {
        Swal.fire({ icon: 'warning', title: 'Invalid Name', text: 'Name must be at least 4 characters.' });
        return;
      }
      if (!email || !address) {
        Swal.fire({ icon: 'warning', title: 'Missing Information', text: 'Please fill out all required fields.' });
        return;
      }
      if (cart.length === 0) {
        Swal.fire({ icon: 'warning', title: 'Empty Cart', text: 'Your cart is empty.' });
        return;
      }

      Swal.fire({ title: 'Processing your order...', html: 'Please wait...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
      setTimeout(() => {
        document.getElementById("cart_data").value = JSON.stringify(cart);
        document.getElementById("checkoutForm").submit();
      }, 1500);
    };

    // ---------------- Rating ----------------
    const submitRating = (productId, rating) => {
      fetch(`https://admindashboardflask-production-1a1e.up.railway.app/api/product/${productId}/rate`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rating })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          selected_product.value.rating_rate = data.rating_rate;
          selected_product.value.rating_count = data.rating_count;
          selected_product.value.userRating = rating;

          Swal.fire({
            icon: 'success',
            title: 'Thanks!',
            text: `You rated this ${rating} star(s).`,
            timer: 1200,
            showConfirmButton: false
          });
        } else {
          Swal.fire({ icon: 'error', title: 'Oops!', text: data.message });
        }
      })
      .catch(err => {
        console.error("Error submitting rating:", err);
        Swal.fire({ icon: 'error', title: 'Network Error', text: 'Could not send rating.' });
      });
    };

    onMounted(() => {
      const form = document.getElementById('checkoutForm');
      if (form) {
        form.addEventListener('submit', (e) => { e.preventDefault(); validateCheckout(); });
      }
    });

    return {
      cart_list,
      cartCount,
      products,
      product,
      selected_product,
      searchQuery,
      priceLimit,
      filteredProducts,
      quantity,
      addToCart,
      removeCartItem,
      increaseQty,
      decreaseQty,
      showProductDetail,
      subtotal,
      shipping,
      tax,
      total,
      isCartModalVisible,
      showCartModal,
      proceedToPurchase,
      checkout,
      validateCheckout,
      submitRating
    };
  }
}).mount('#productApp');
</script>

<script>
if (document.cookie.includes('clear_cart=1')) {
  localStorage.removeItem('cart');
  document.cookie = "clear_cart=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
}
</script>

</html>
